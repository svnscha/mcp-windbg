name: Publish MCP Server

on:
  push:
    tags: ["v*"]      # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-test:
    uses: ./.github/workflows/build-and-test.yml

  publish:
    runs-on: windows-latest
    needs: build-and-test
    permissions:
      id-token: write  # OIDC for trusted publishing
      contents: read

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-and-test.outputs.artifact-name }}
        path: dist/

    - name: List downloaded artifacts
      run: |
        Write-Host "Downloaded artifacts:"
        Get-ChildItem -Path "dist/" -Recurse | Format-Table Name, Length, LastWriteTime

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true

    - name: Create GitHub Release Summary
      run: |
        Write-Host "## ðŸŽ‰ Package Published Successfully!"
        Write-Host "ðŸ“¦ Published to **PyPI**: https://pypi.org/project/mcp-windbg/"
        Write-Host ""
        Write-Host "### Installation"
        Write-Host '```bash'
        Write-Host 'pip install mcp-windbg'
        Write-Host '```'
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY

  publish-mcp-registry:
    runs-on: ubuntu-latest
    needs: [build-and-test, publish]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/download/v1.2.3/mcp-publisher_1.2.3_$(uname -s | tr '[:upper:]' '[:lower:]')_amd64.tar.gz" | tar xz mcp-publisher

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
