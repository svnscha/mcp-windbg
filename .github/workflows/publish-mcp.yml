name: Publish MCP Server

on:
  push:
    tags: ["v*"]      # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-test:
    uses: ./.github/workflows/build-and-test.yml

  verify-build:
    runs-on: windows-latest
    needs: build-and-test

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-and-test.outputs.artifact-name }}
        path: dist/

    - name: List downloaded artifacts
      run: |
        Write-Host "Downloaded artifacts:"
        Get-ChildItem -Path "dist/" -Recurse | Format-Table Name, Length, LastWriteTime

  publish-pypi:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      id-token: write  # OIDC for trusted publishing
      contents: read

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-and-test.outputs.artifact-name }}
        path: dist/

    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        ls -la dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true

    - name: Create GitHub Release Summary
      run: |
        echo "## ðŸŽ‰ Package Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Published to **PyPI**: https://pypi.org/project/mcp-windbg/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo 'pip install mcp-windbg' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  publish-mcp-registry:
    runs-on: ubuntu-latest
    needs: [build-and-test, publish-pypi]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/download/v1.2.3/mcp-publisher_1.2.3_$(uname -s | tr '[:upper:]' '[:lower:]')_amd64.tar.gz" | tar xz mcp-publisher

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
